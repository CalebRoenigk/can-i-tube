<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Can I Tube?</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="assets/font/font.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
  </head>
  <body class="bkgd-no">
    <div class="title-block">
      <h3 id="title-prefix">IS THE</h3>
      <h2 id="title-main">NEW RIVER</h2>
      <h3 id="title-sufix">SAFE FOR ME TODAY?</h3>
    </div>
    <div class="answer-block">
      <div id="answer-answer">
      </div>
      <div id="answer-flow">
      </div>
    </div>
    <div class="range-block">
      <div id="range-label">
        <h5>SAFE RANGE</h5>
      </div>
      <div class="range-rule">
        <div class="range-rule-line"></div>
        <div class="range-rule-measurement range-low">
        </div>
        <div class="range-rule-measurement range-high">
        </div>
        <div class="range-rule-indicator">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 15"><path class="range-rule-indicator-path" d="M7.5 1L0 14h15z"/></svg>
        </div>
      </div>
      <div id="range-unit">
        <h5>FT<span class="superscript">3</span>/S</h5>
      </div>
    </div>
    <div class="graph-block" id="graph">
      <canvas id="flowChart"></canvas>
    </div>
    <div class="contact-block">
      <div id="contact-message">
      </div>
      <div id="contact-information">
      </div>
    </div>
  </body>
  <script type="text/javascript">
  console.log("Can I Tube: v1.0.0");
  populateData("03161000");

  // This function fetches the data using AJAX if the data has not already been stored in a cookie
  function fetchData(site, cookieName) {
    var dataCookiePresent = checkCookie(cookieName);

    if(dataCookiePresent == false) {
      return new Promise((resolve, reject) => {
        $.ajax({
          url: "https://waterservices.usgs.gov/nwis/iv/?format=json&sites=" + site + "&period=P3D&parameterCd=00060&siteStatus=active",
          dataType: 'JSON',
          data: '',
          success: function(json){
            console.log("Data Retreived!")
            resolve(json);
           },
          error : function(XMLHttpRequest, textStatus, errorThrown) {
             console.log("Error: AJAX request failed...");
             console.log(textStatus);
             console.log(errorThrown);
          }
        });
      })
    } else {
      // Grab the non-expired data
      return "Data Already Present!";
    }
  }

  // This function populates the data to the site
  async function populateData(site) {
    // For now this site name is just new river but will eventually be the name of any site selected by the user
    var siteName = "newRiver";
    var siteCookieName = siteName + "Data";

    // Fetch the data
    var jsonData = await fetchData(site, siteCookieName);

    // If the data is already stored as cookies, grab that data, else store that data to cookies
    if(jsonData == "Data Already Present!") {
      var flowArray = getCookie("newRiverFlow").split(",");
      var dateSaved = getCookie(siteCookieName);
    } else {
      // Return data arrays for data population and cookie storage
      var flowArray = createDataArray(jsonData, "value");

      // Store the data to the site data cookies, set the cookies to expire in 1 day
      var dateSaved = new Date();
      dateSaved = dateSaved.getMonth() + "/" + dateSaved.getDay();
      // siteNameData: The date that the cookie was created
      writeCookie(siteCookieName, dateSaved, 1);
      // siteNameFlow: The flow values retreived
      writeCookie("newRiverFlow", flowArray, 1);
    }

    // Log the data
    console.log(dateSaved);
    console.log(flowArray);

    // Create the date array
    var dateTimeArray = createDateTimeArray(flowArray, dateSaved);

    console.log(dateTimeArray);

    // Extract the values
    //grabValues(jsonData);

    // Place the values in a more graph friendly format
    var graphArray = createGraphArray(dateTimeArray, flowArray);

    // For now this is a single value, will determine if it shifts later
    var safeRange = {
      "min": 400,
      "max": 1000
    };

    var currentFlow = flowArray[flowArray.length-1];

    // Test if the current flow value is within the safe range
    if(currentFlow > (safeRange.min - 1) && currentFlow < (safeRange.max + 1)) {
      // Test if the average value is within a percentage of the safe range
      var rangeVariance = .25;
      var rangeSize = safeRange.max - safeRange.min;
      var superSafeRange = {
        "min": safeRange.min + (rangeSize*(rangeVariance/2)),
        "max": safeRange.max - (rangeSize*rangeVariance)
      };
      if(currentFlow > (superSafeRange.min - 1) && currentFlow < (superSafeRange.max + 1)) {
        // Today is safe
        console.log("Today is safe!");
        createFlowGraph(graphArray, "#261C15");
        formatPage("YES", currentFlow, safeRange);
      } else {
        // Today is maybe safe
        console.log("Today is maybe safe?");
        createFlowGraph(graphArray, "#E4E6C3");
        formatPage("MAYBE", currentFlow, safeRange);
      }
    } else {
      // Today is not safe
      console.log("Today is not safe!");
      createFlowGraph(graphArray, "#EAC435");
      formatPage("NO", currentFlow, safeRange);
    }
  }

  // This function creates the date time array based on the flow array length and cookie save date
  function createDateTimeArray(ary, endDate) {
    var returnArray =[];
    var weekdayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    var year = new Date().getFullYear();
    var timezone = "GMT-0400 (Eastern Daylight Time)";

    var endDay = parseInt(endDate.split("/")[1]);
    var currentMonth = monthNames[parseInt(endDate.split("/")[0])];
    // Iterate for length of array
    for(var i=ary.length-1; i > -1; i--) {
      var currentDay = weekdayNames[endDay - Math.floor(i/96)];
      var currentHour = addLeadingZeros(Math.floor(((i%96)/96)*24), 2);
      var currentMin = addLeadingZeros((Math.floor(((i%96)/96)*24)%1)*60, 2);
      var currentValue = currentDay + " " + currentMonth + " " + (endDay - Math.floor(i/96)) + " " + year + " " + currentHour + ":" + currentMin + ":00 " + timezone;

      returnArray.push(currentValue);
    }

    return returnArray;
  }

  // This function adds leading zeros if a passed number isn't a passed length
  function addLeadingZeros(value, size) {
    value = value.toString();
    if(value.length !== size) {
      for(var i=0; i < size-1; i++) {
        value = "0" + value;
      }
      return value;
    } else {
      return value;
    }
  }

  // This function grabs data based on the passed key and data and returns it in an array
  function createDataArray(data, key) {
    var returnArray = [];
    // Iterate over the data
    for(var i=0; i < data.value.timeSeries[0].values[0].value.length; i++) {
      var currentValue = data.value.timeSeries[0].values[0].value[i][key];

      returnArray.push(currentValue);
    }

    // Return the data
    return returnArray;
  }

  // This function returns a graph array full of objects based on passed data
  function createGraphArray(dateAry, flowAry) {
    var returnArray = [];
    // Iterate over the flow array, adding all the data to a single object and pushing that to the return array
    for(var i=0; i < flowAry.length; i++) {

      var dateTime = dateAry[i];
      dateTime = dateTime.split("GMT")[0].substr(0, dateTime.split("GMT")[0].length-1);

      // Parse Date
      var parser = d3.timeParse("%Y-%m-%dT%H:%M:%S");
      dateTime = parser(dateTime);

      var currentObjData = {
        "x": dateTime,
        "y": flowAry[i]
      };

      returnArray.push(currentObjData);
    }

    return returnArray;
  }

// This function formats the page styles to match the river state
function formatPage(state, currentFlowValue, safeRange) {
  var contactStrings = {
    "NO": "Doesn’t Look Like Today’s The Day! Conact the Park for more info.",
    "MAYBE": "Looks a Little Close to Call. Check with The Park to Be Safe.",
    "YES": "Looks Optimal, but just to be sure you should contact the park."
  }

  // Clear all formatting
  $('body').removeClass("bkgd-no bkgd-maybe bkgd-yes");
  $('.range-rule-line').removeClass("no-state-fill maybe-state-fill yes-state-fill");
  $('.range-rule-indicator-path').removeClass("no-state-svg-fill maybe-state-svg-fill yes-state-svg-fill");

  // Add the current flow text
  var currentFlowText = '<h4>CURRENT FLOW: ' + currentFlowValue + ' FT<span class="superscript">3</span>/S</h4>';
  $('#answer-flow').append(currentFlowText);

  // Add the current state answer
  var currentAnswerText = '<h1>' + state + '</h1>';
  $('#answer-answer').append(currentAnswerText);

  // Add the contact text
  var contactText = '<h5>' + contactStrings[state] + '</h5>';
  $('#contact-message').append(contactText);

  // Add the contact info
  var contactInfoText = '<h4>336-982-2587</h4>';
  $('#contact-information').append(contactInfoText);

  // Change the range rule text
  var rangeLowText = '<h5>' + safeRange.min + '</h5>';
  var rangeHighText = '<h5>' + safeRange.max + '</h5>';
  $('.range-low').append(rangeLowText);
  $('.range-high').append(rangeHighText);

  // Set up the range ruler
  if(safeRange.max > currentFlowValue) {
    var maxFlow = safeRange.max*1.25;
  } else {
    var maxFlow = currentFlowValue*1.25;
  }
  var scaleSlope = (maxFlow - 0)/(100 - 0);
  var indicatorPostion = parseInt(currentFlowValue)/scaleSlope;
  var lowRangePosition = safeRange.min/scaleSlope;
  var highRangePosition = safeRange.max/scaleSlope;

  $('.range-rule-indicator').css("left", indicatorPostion + "%");
  $('.range-low').css("left", lowRangePosition + "%");
  $('.range-high').css("left", highRangePosition + "%");

  // Test for state
  if(state == "NO") {
    // No State
    $('body').addClass("bkgd-no");
    $('.range-rule-line').addClass("no-state-fill");
    $('.range-rule-indicator-path').addClass("no-state-svg-fill");
  }
  if(state == "MAYBE") {
    // Maybe State
    $('body').addClass("bkgd-maybe");
    $('.range-rule-line').addClass("maybe-state-fill");
    $('.range-rule-indicator-path').addClass("maybe-state-svg-fill");
  }
  if(state == "YES") {
    // Yes State
    $('body').addClass("bkgd-yes");
    $('.range-rule-line').addClass("yes-state-fill");
    $('.range-rule-indicator-path').addClass("yes-state-svg-fill");
  }
}

// This function creates the flow graph
function createFlowGraph(data, lineColor) {
  var x = [];
  var y = [];

  for(var i=0; i < data.length; i++) {
    var currentX = data[i].x;
    x.push(currentX);
    y.push(data[i].y);
  }

  var ctx = document.getElementById('flowChart').getContext('2d');
  Chart.defaults.global.defaultFontColor = lineColor;
  var myLineChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: x,
        datasets: [{
            data: y,
            backgroundColor: 'rgba(0, 0, 0, 0)',
            borderColor: lineColor,
            borderWidth: 2,
            pointBackgroundColor: 'rgba(0, 0, 0, 0)',
            pointBorderColor: 'rgba(0, 0, 0, 0)',
            pointRadius: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: false,
                    min: 100,
                    max: 3500,
                    maxTicksLimit: 2,
                    callback: function(value, index, values) {
                        return value + "FT³/S";
                    }
                },
                gridLines: {
                  display: false
                }
            }],
            xAxes: [{
                ticks: {
                  maxTicksLimit: 7
                },
                gridLines: {
                  display: false
                }
            }]
        },
        legend: {
          display: false
        },
        tooltip: {
          enabled: false
        }
    }
});
}

// This function writes a cookie ith a name, data, and a number of days before expiring
function writeCookie(name, data, expire) {
  var now = new Date();
  now.setDate(now.getDate() + expire);
  var exp = now;
  document.cookie = name + "=" + data + ";" + "expires=" + exp.toUTCString() + ";";
}

// This function returns the data in a cookie of a specified name
function getCookie(cname) {
  var name = cname + "=";
  var decodedCookie = decodeURIComponent(document.cookie);
  var ca = decodedCookie.split(';');
  for(var i = 0; i <ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

// This function checks for a cookie to see if it is present
function checkCookie(name) {
  var cookieCheck = getCookie(name);
  if (cookieCheck == "") {
   return false;
  } else {
    if (cookieCheck !== "" && cookieCheck !== null) {
      return true;
    }
  }
}


  </script>
</html>
